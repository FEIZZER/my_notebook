## 常见API

### 绑定设备

绑定是非常常用的过滤手段， 可以通过编程产生一个虚拟的设备， 将他绑定到另一个真实设备上。 一旦被绑定， 操作系统会将本来发给真实设备的请求发给我们生成的虚拟设备。

在WDK中有非常多的内核API实现设备绑定的功能：

- ```c
  NTSTATUS IoAttachDevice(
  	[IN] PDEVICE_OBJECT filterObject, 	// 由调用者生成的用来过滤的虚拟设备
      [IN] PUNICODE_STRING targetObject, 	// 被绑定设备的名字的字符串
      [OUT] PDEVICE_OBJECT *attachedObject  // 返回被调用设备对象的指针
  )
  ```

  第二个参数的类型是`PUNICODE_STRING`, 用来表示被绑设备的名字， 也就是说只有有名字的设备才可以使用这个API来进行绑定*window中有一些设备对象是没有名字的*。

  第三个参数返回的被绑定的参数其实就是绑定之前设备栈上最顶端的设备。

- ```c
  NTSTATUS IoAttachDeviceToDeviceStackSafe(
    [in]  PDEVICE_OBJECT SourceDevice,			// 由调用者生成的用来过滤的虚拟设备
    [in]  PDEVICE_OBJECT TargetDevice,			// 被绑定设备对象的指针
    [out] PDEVICE_OBJECT *AttachedToDeviceObject	// 返回被调用设备对象的指针
  );
  ```

  对于没有名字的设备对象可以使用这个函数来进行绑定。

- `IoAttachDeviceToDeviceStack(...)` 功能和上面的函数一样，但是没有出参,如果要支持win2000等老版本，使用这个API

  `IoAttachDeviceToDeviceStackSafe(...)` 更加安全， 但是只在 windows XP 和 windows 2000SP4以上的版本中才可以使用。

#### 解除绑定

```c
void IoDetachDevice(
  [in, out] PDEVICE_OBJECT TargetDevice
);
```

该函数递减targetDevice对象的引用计数。 之前调用了`IoAttachDevice`或`IoAttachDeviceToDeviceStack`对targetDevice绑定了新的设备， 可以用该函数结束绑定。

### 创建设备

- ```c
  NTSTATUS IoCreateDevice(
    [in]           PDRIVER_OBJECT  DriverObject,
    [in]           ULONG           DeviceExtensionSize,
    [in, optional] PUNICODE_STRING DeviceName,
    [in]           DEVICE_TYPE     DeviceType,
    [in]           ULONG           DeviceCharacteristics,
    [in]           BOOLEAN         Exclusive,
    [out]          PDEVICE_OBJECT  *DeviceObject
  );
  ```


#### 删除设备

- ```c
  void IoDeleteDevice(
    [in] PDEVICE_OBJECT DeviceObject
  );
  ```

  指向要删除的设备对象的指针。



### IRP请求处理



