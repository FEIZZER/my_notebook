## DNS协议

> dns服务是为了 在 **域名** 和 **ip** 之间提供一个映射关系。 域名通常是一些有意义的单词的组合，方便记忆。
>
> dns协议属于应用层协议， 运行在UDP协议之上，使用端口号53。在RFC文档中RFC 2181对dns有规范说明，RFC 2136对dns的动态更新进行说明，RFC 2308对dns查询的反向缓存进行说明。

#### dns解析流程

##### 域名的层次流程

 DNS 系统采用的是分布式的解析方案，整个DNS 架构是一种层次树状结构，这个树状结构称为 DNS 域名空间。

![未命名文件 (4)](C:/Users/yongjianwu/Downloads/未命名文件 (4).png) 

- 树状结构的顶层称为根域 ".", 相应的服务被称为根服务器， 这个域名空间的解析权都归根服务器所有

- 在根域下设置了顶级域，然后将不同顶级域的解析权交给了顶级域服务器，比如com域的解析权委派给了com域服务器，以后和com结尾的域名解析请求，都会转发给com域服务器

  顶级域也有各种分类：

  - **国家顶级域**  中国cn  美国us  日本jp
  - **通用顶级域**  公司企业com 政府部门gov 国际组织int 军事组织mil net网络 非盈利组织org
  - **反向域名**      arpa

- 为了减轻顶级域的压力，又设下了二级域，二级域下面又设下了三级域或主机。

##### 域名服务器的层次结构

 域名具有层次结构，域名需要服务器进行管理，域名服务器也有层次结构。

由高向低进行层次划分，可分为以下几大类：

| 分类           | 作用                                                         |
| :------------- | :----------------------------------------------------------- |
| 根域名服务器   | 最高层次的域名服务器，本地域名服务器解析不了的域名就会向其求助 |
| 顶级域名服务器 | 负责管理在该顶级域名服务器下注册的二级域名                   |
| 权限域名服务器 | 负责一个区的域名解析工作                                     |
| 本地域名服务器 | 当一个主机发出DNS查询请求时，这个查询请求首先发给本地域名服务器 |

##### 域名解析流程

1. 我在我的笔记本电脑访问baidu.com, 操作系统会先检查自己的本地hosts文件有没有这个域名的网址映射关系， 如果有就直接调用映射关系，完成域名解析。
2. 如果hosts文件中没有这个域名的网址映射关系则查找本地的DNS缓存，如果有则返回网址映射关系， 完成域名解析
3. 如果hosts与本地DNS解析器缓存都没有相应的网址映射关系，首先会找TCP/IP参数中设置的首选DNS服务器，在此我们叫它**本地DNS服务器**。 
   1. 此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。
   2. 如果要查询的域名，不由本地DNS服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个IP地址映射，完成域名解析，此解析不具有权威性。
   3. 如果本地DNS服务器本地区域文件与缓存解析都失效，则根据本地DNS服务器的设置（是否设置转发器）进行查询
4. 如果本地服务器设置为**不转发**，  这种查询方式称为**迭代查询**
   1. 本地服务器会发送请求给根服务器， 根服务器收到请求后会查看改顶级域(.com)由谁来管理, 返回改该顶级域服务器的ip地址。
   2. 本地服务器收到该顶级域服务器ip后，再向顶级域服务器请求， 如果顶级域无法解析，则返回(baidu.com)域的服务器ip。
   3. 本地服务器重复上述操作， 直至找到（www.baidu.com）的主机ip
5. 如果本地服务器设置为**转发模式**， 这种查询方式被称为**递归查询**
   1. 此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把转请求转至上上级，以此循环。
6. 不管是本地DNS服务器用是是转发，还是根提示，最后都是把结果返回给本地DNS服务器，由此本地DNS服务器再返回给我的笔记本电脑。





