# Windows的进程与线程





## Windows进程创建和映像加载 *以win32为主*

在**Win32 API**中进程创建由 `Kernel32.dll!CreateProcess()`完成。 

### Windows新建一个用户态进程的过程

1. 打开目标映像文件
2. 创建内核中的进程的对象
3. 创建这个进程的第一个线程， 包括其堆栈，上下文， 以及**管理层线程对象**， *即线程控制块 ETHREAD的数据结构和相应的句柄*。
4. 通知 Windows子系统
5. 启动进程中的第一个线程， （创建参数中的CREATE_SUSPENDED标志为1除外， 因为一创建就被挂起）。
6. 在新创建的进程和线程的上下文中完成用户空间的初始化， 包括装入和连接多需要的Dll， 最后开始目标程序的运行。





下面对6个阶段分别分析

##### step1 打开目标映像文件

windows上可运行的可执行软件有好几种， 有着不同的拓展名， 处理的方式也会不一样：

- Win32位的EXE映像文件
- Win16位的EXE映像文件， 启动ntvdm.exe, 原有命令作为参数运行
- DOS的 EXE，COM，PIF映像，  启动ntvdm.exe, 原有命令作为参数运行
- DOS的BAT或CMD批命令文件， 启动cmd.exe 原有命令作为参数
- POSIX可执行映像， 启动posix.exe， 以原有命令作为参数
- OS/2可执行映像， 启动os2.exe， 以原因命令作为参数



**以32位的映像文件为例**， `CreateProcess()` 首先打开该映像文件， 再为其分配一个**Section** 文件映射区。 检查完映像文件的合法性和是否需要以debug方式加载后， 将映像文件载入刚刚创建的Section区域。

*判断是否需要的debug的方式*



##### step2 创建内核中的进程对象





